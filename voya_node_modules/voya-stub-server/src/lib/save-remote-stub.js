'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
    value: true
});
exports['default'] = saveRemoteStub;

var _zlib = require('zlib');

var _zlib2 = _interopRequireDefault(_zlib);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _state = require('../state');

var _state2 = _interopRequireDefault(_state);

var _libConstants = require('../lib/constants');

function writeStub(stubPath, responseString) {
    var responseJSON;

    try {
        responseJSON = JSON.parse(responseString);
    } catch (e) {
        console.log('skipping writing server response to disk since it could not be parsed as JSON. PATH=' + stubPath);
        return;
    }

    _fs2['default'].writeFile(stubPath, responseString, function (err) {
        if (err) {
            console.log('Error writing stub to disk: ' + stubPath + ' Error:' + err);
        } else {
            console.log('Stub written to disk:' + stubPath);
        }
    });
}

function saveRemoteStub(proxyRes) {
    var responseString = '';
    var reqPath = proxyRes.req.path.substring(1); //remove first slash
    var method = proxyRes.req.method;
    var stubName = _state2['default'].saveRemoteStubsAs;
    var stubPath = '' + _libConstants.STUB_PATH + reqPath + '/' + method + '/' + stubName + '.json';
    var dataSource;

    if (proxyRes.headers['content-encoding'] === 'gzip') {
        var gunzip = _zlib2['default'].createGunzip();
        proxyRes.pipe(gunzip);
        dataSource = gunzip;
    } else {
        dataSource = proxyRes;
    }

    dataSource.on('data', function (chunk) {
        responseString += chunk.toString();
    }).on('end', function () {
        writeStub(stubPath, responseString);
    });
}

module.exports = exports['default'];