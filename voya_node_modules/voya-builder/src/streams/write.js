var async = require('async');
var setStatus = require('../set-status.js');
var c = require('../constants.js');
var fs = require('fs');
var path = require('path');

/**
 * Writes to the config file
 * @param config
 * @param lager$
 * @returns {Function}
 */
module.exports = function write(config, lager$) {
    var systemCfg = {};

    return function (bundleCfg, done) {
        async.waterfall([
            async.constant(bundleCfg),
            function (bundleCfg, next) {
                systemCfg['/' + bundleCfg.bundleFile] = bundleCfg.modules;
                fs.writeFile(path.resolve(config.base, config.configDest), 'System.config({bundles:' + JSON.stringify(systemCfg) + '});', function (err, res) {
                    if (err) { throw err; }

                    done(null, bundleCfg);
                });
            }
        ], done);
    }
};
