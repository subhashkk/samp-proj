var async = require('async');
var path = require('path');

var spawn = require('../lib/spawn.js');
var setStatus = require('../set-status.js');
var c = require('../constants.js');

module.exports = function build(config, lager$) {
    return function (bundleCfg, done) {
        async.waterfall([
            async.constant(bundleCfg),
            setStatus(c.S_BUILDING, lager$),
            function (bundleCfg, next) {
                spawn(path.resolve(__dirname, '../workers/builder.js'), bundleCfg, config, function (err, bundleCfg) {
                    if (err) {
                        console.log(err);
                        setStatus(c.S_ERR, lager$)(bundleCfg, next);
                    } else {
                        setStatus(c.S_BUILT, lager$)(bundleCfg, next);
                    }
                });
            }
        ], done);
    }
};
