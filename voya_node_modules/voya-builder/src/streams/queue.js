var async = require('async');

var lager = require('./lager.js');
var build = require('./build.js');
var watch = require('./watch.js');
var write = require('./write.js');
var setStatus = require('../set-status.js');
var c = require('../constants.js');

module.exports = function queue(config) {

    var lager$ = async.queue(lager(config, process.stdout), 1);
    var build$ = async.queue(build(config, lager$), 23);
    var write$ = async.queue(write(config, lager$), 1);

    var queue$ = async.queue(function (bundleCfg, done) {
        if (bundleCfg.status !== c.S_BUILDING) {
            async.waterfall([
                async.constant(bundleCfg),
                setStatus(c.S_QUEUED, lager$),
                build$.push,
                write$.push,
                (config.watch && watch$.push)
            ].filter(Boolean), done);
        }
    }, 1);
    // todo: we can not have concurrent builds until jspm issue is fixed
    // todo: https://github.com/jspm/jspm-cli/issues/1198

    var watch$ = async.queue(watch(config, lager$, queue$), 1);

    return queue$;
};
