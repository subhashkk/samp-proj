require('../lib/worker.js')(function (bundleCfg, config, done) {
    var path = require('path');
    var jspm = require('jspm');
    var builder = new jspm.Builder();

    bundleCfg.bundleFile = getDestination(bundleCfg, config);

    builder.bundle(jspmString(bundleCfg), path.join(config.base || '', bundleCfg.bundleFile), {minify: config.minify, sourceMaps: config.sourceMaps})
        .then(function (output) {
            bundleCfg.modules = output.modules;

            done(null, bundleCfg);
        }, function (err) {
            console.log(err);
            done(err, bundleCfg);
        });

    function jspmString(bundleCfg) {
        return bundleCfg.includes.join(' + ') + (bundleCfg.excludes ? ' - ' + bundleCfg.excludes.join(' - ') : '');
    }

    function getDestination(bundleCfg, config) {
        var name = config.cacheBust ? config.cacheBust + '-' + bundleCfg.name : bundleCfg.name;
        return path.join(config.bundleDest, name + '.js');
    }
});
